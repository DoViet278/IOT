<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>IoT - Action History</title>
    <link rel="stylesheet" href="history.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
   <div class="layout">
        <nav class="navbar">
            <div class="sidebar-title">
                <i class="fa-brands fa-pagelines"></i>
                <h2>IOT</h2>
            </div>

            <div class="nav-links">
                <a href="index.html" ><i class="fa-solid fa-house"></i> Dashboard</a>
                <a href="sensors.html"><i class="fa-solid fa-database"></i> Data Sensors</a>
                <a href="history.html"  class="active"><i class="fa-solid fa-clock-rotate-left"></i> Actions History</a>
                <a href="profile.html"><i class="fa-solid fa-user"></i> Profile</a>
            </div>
        </nav>

    <div class="container">
        <header class="main-header">
            <div class="title-area">
                <h1>Lịch sử hoạt động</h1>
            </div>
        </header>

        <div class="filter-bar">
            <div class="search-group">
                <div class="input-with-icon">
                    <i class="fa-solid fa-calendar"></i>
                    <input type="date">
                </div>
                <div class="input-with-icon">
                    <i class="fa-solid fa-clock"></i>
                    <input type="time">
                </div>
                <button class="btn-search"><i class="fa-solid fa-magnifying-glass"></i> Tìm kiếm</button>

            </div>
            <select class="sensor-filter">
                <option value="all">Tất cả thiết bị</option>
                <option value="light">Đèn</option>
                <option value="fan">Quạt</option>
                <option value="air">Điều hòa</option>
            </select>
        </div>

        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Thiết bị</th>
                        <th>Hành động</th>
                        <th>Trạng thái</th>
                        <th>Thời gian</th>
                    </tr>
                </thead>
                <tbody id="history-data"></tbody>
            </table>
        </div>

        <div class="pagination" id="pagination">
            <button class="page-btn"><i class="fa-solid fa-chevron-left"></i></button>
            <button class="page-btn active">1</button>
            <button class="page-btn"><i class="fa-solid fa-chevron-right"></i></button>
        </div>
    </div>
   </div>
   <script>
const API_BASE = "http://localhost:3001/api/devices";

let currentPage = 1;
let currentSearch = "";
let currentDevice = "";
const limit = 10;

const tableBody = document.getElementById("history-data");
const paginationContainer = document.getElementById("pagination");

const searchBtn = document.querySelector(".btn-search");
const dateInput = document.querySelector("input[type='date']");
const timeInput = document.querySelector("input[type='time']");
const deviceFilter = document.querySelector(".sensor-filter");


// =======================
// FORMAT DATE dd/mm/yy HH:mm:ss
// =======================
function formatDate(dateStr) {
    const date = new Date(dateStr);

    const dd = String(date.getDate()).padStart(2, "0");
    const mm = String(date.getMonth() + 1).padStart(2, "0");
    const yy = String(date.getFullYear()).slice(-2);

    const hh = String(date.getHours()).padStart(2, "0");
    const min = String(date.getMinutes()).padStart(2, "0");
    const ss = String(date.getSeconds()).padStart(2, "0");

    return `${dd}/${mm}/${yy} ${hh}:${min}:${ss}`;
}


// =======================
// LOAD DATA
// =======================
async function loadData() {

    const params = new URLSearchParams({
        limit,
        page: currentPage
    });

    if (currentSearch) params.append("search", currentSearch);
    if (currentDevice) params.append("deviceId", currentDevice);

    try {
        const res = await fetch(`${API_BASE}?${params}`);
        const result = await res.json();

        renderTable(result.data);
        renderPagination(result.totalPages);

    } catch (error) {
        console.error("Lỗi load history:", error);
    }
}


// =======================
// RENDER TABLE
// =======================
function renderTable(data) {

    if (!data || data.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align:center">Không có dữ liệu</td>
            </tr>
        `;
        return;
    }

    let html = "";

    data.forEach(item => {

        let statusClass = "";
        let statusText = "";

        if (item.Status === "Success") {
            statusClass = "success";
            statusText = "Thành công";
        }
        else if (item.Status === "Processing") {
            statusClass = "pending";
            statusText = "Đang xử lý";
        }
        else {
            statusClass = "fail";
            statusText = "Thất bại";
        }

        html += `
            <tr>
                <td>#${item.ID}</td>
                <td>${item.DeviceName}</td>
                <td>${item.Action}</td>
                <td><span class="status ${statusClass}">${statusText}</span></td>
                <td>${formatDate(item.CreatedAt)}</td>
            </tr>
        `;
    });

    tableBody.innerHTML = html;
}


// =======================
// PAGINATION (3 PAGE STYLE)
// =======================
function renderPagination(totalPages) {

    paginationContainer.innerHTML = "";

    if (totalPages <= 1) return;

    // PREV
    const prevBtn = document.createElement("button");
    prevBtn.className = "page-btn";
    prevBtn.innerHTML = `<i class="fa-solid fa-chevron-left"></i>`;
    prevBtn.disabled = currentPage === 1;

    prevBtn.onclick = () => {
        if (currentPage > 1) {
            currentPage--;
            loadData();
        }
    };

    paginationContainer.appendChild(prevBtn);

    let startPage = Math.max(1, currentPage - 1);
    let endPage = Math.min(totalPages, startPage + 2);

    if (endPage - startPage < 2) {
        startPage = Math.max(1, endPage - 2);
    }

    for (let i = startPage; i <= endPage; i++) {

        const btn = document.createElement("button");
        btn.className = "page-btn";
        btn.textContent = i;

        if (i === currentPage) btn.classList.add("active");

        btn.onclick = () => {
            currentPage = i;
            loadData();
        };

        paginationContainer.appendChild(btn);
    }

    // NEXT
    const nextBtn = document.createElement("button");
    nextBtn.className = "page-btn";
    nextBtn.innerHTML = `<i class="fa-solid fa-chevron-right"></i>`;
    nextBtn.disabled = currentPage === totalPages;

    nextBtn.onclick = () => {
        if (currentPage < totalPages) {
            currentPage++;
            loadData();
        }
    };

    paginationContainer.appendChild(nextBtn);
}


// =======================
// SEARCH
// =======================
searchBtn.addEventListener("click", () => {

    const date = dateInput.value;
    const time = timeInput.value;

    if (date) {
        currentSearch = time ? `${date} ${time}` : date;
    } else {
        currentSearch = "";
    }

    currentPage = 1;
    loadData();
});


// =======================
// FILTER DEVICE
// =======================
deviceFilter.addEventListener("change", () => {

    const value = deviceFilter.value;

    if (value === "light") currentDevice = 1;
    else if (value === "fan") currentDevice = 2;
    else if (value === "air") currentDevice = 3;
    else currentDevice = "";

    currentPage = 1;
    loadData();
});


// INIT
loadData();

</script>
</body>
</html>